---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import ProjectCard from '@/components/portfolio/ProjectCard.astro';
import ProjectSpine from '@/components/portfolio/ProjectSpine.astro';
import ViewToggle from '@/components/portfolio/ViewToggle.astro';

// Get all non-draft projects
const projects = await getCollection('projects', ({ data }) => !data.draft);

// Split projects by category, sorted by date (most recent first)
const brandingProjects = projects
  .filter(p => p.data.category === 'branding')
  .sort((a, b) => b.data.publishedDate.getTime() - a.data.publishedDate.getTime());

const bookProjects = projects
  .filter(p => p.data.category === 'book')
  .sort((a, b) => b.data.publishedDate.getTime() - a.data.publishedDate.getTime());

// Get all designers for lookup
const designers = await getCollection('designers');
const designerMap = new Map(designers.map(d => [d.id, d.data.name]));
---

<BaseLayout
  title="Work | Quality Time"
  description="Selected projects and collaborations from Quality Time design collective."
>
  <!-- Branding Section -->
  <section class="work-section">
    <header class="section-header">
      <span class="section-label" data-animate>Branding</span>
      <p class="section-description" data-animate style="--stagger: 1">
        Visual identities for brands, exhibitions, and events.
      </p>
    </header>
    <div class="grid-container">
      {brandingProjects.map((project, index) => (
        <ProjectCard project={project} index={index} priority={index < 4} />
      ))}
    </div>
  </section>

  <!-- Publishing Section -->
  <section class="work-section publishing-section">
    <header class="section-header">
      <div class="section-header-text">
        <span class="section-label" data-animate>Publishing</span>
        <p class="section-description" data-animate style="--stagger: 1">
          Art books, zines, and printed matter. Self-initiated projects where we get to do whatever we want.
        </p>
      </div>
      <ViewToggle />
    </header>

    <!-- Spines View (default) -->
    <div class="spines-container" data-books-container="spines">
      {bookProjects.map((project, index) => (
        <ProjectSpine project={project} index={index} designerMap={designerMap} />
      ))}
    </div>

    <!-- Shelf View -->
    <div class="grid-container" data-books-container="shelf" hidden>
      {bookProjects.map((project, index) => (
        <ProjectCard project={project} index={index} priority={false} />
      ))}
    </div>
  </section>
</BaseLayout>

<style>
  /* ==========================================================================
     Work Sections
     ========================================================================== */
  .work-section {
    padding: 0 var(--gutter) var(--space-24);
    max-width: var(--container-xl);
    margin: 0 auto;
  }

  .work-section:first-child {
    padding-top: var(--space-24);
  }

  .work-section:last-child {
    padding-bottom: var(--section-gap);
  }

  .section-header {
    margin-bottom: var(--space-12);
  }

  .section-label {
    display: block;
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    letter-spacing: var(--tracking-caps);
    text-transform: uppercase;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .section-description {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: var(--font-regular);
    line-height: var(--leading-snug);
    letter-spacing: var(--tracking-tight);
    color: var(--color-text-primary);
    max-width: 28ch;
  }

  /* Publishing section header with toggle */
  .publishing-section .section-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-8);
  }

  .section-header-text {
    flex: 1;
  }

  /* ==========================================================================
     Grid View (Shelf)
     ========================================================================== */
  .grid-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-12) var(--space-8);
  }

  /* Staggered grid for visual interest */
  .grid-container > :global(:nth-child(2n)) {
    margin-top: var(--space-16);
  }

  .grid-container[hidden] {
    display: none;
  }

  /* ==========================================================================
     Spines View
     ========================================================================== */
  .spines-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .spines-container[hidden] {
    display: none;
  }

  /* ==========================================================================
     Responsive
     ========================================================================== */
  @media (max-width: 768px) {
    .grid-container {
      grid-template-columns: 1fr;
      gap: var(--space-12);
    }

    .grid-container > :global(:nth-child(2n)) {
      margin-top: 0;
    }

    .section-description {
      font-size: var(--text-xl);
    }

    .publishing-section .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-6);
    }
  }
</style>

<script>
  function initWorkPage() {
    // Scroll-triggered reveal animations
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);

    document.querySelectorAll('[data-animate]').forEach((el) => {
      observer.observe(el);
    });
  }

  // Initialize on load
  initWorkPage();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initWorkPage);
</script>
