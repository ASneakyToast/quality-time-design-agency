---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

// Get featured designers (exclude the studio entry, order by order field)
const designers = await getCollection('designers', ({ id, data }) =>
  id !== 'studio' && data.order > 0
);
const sortedDesigners = designers.sort((a, b) => a.data.order - b.data.order).slice(0, 2);

// Get all projects to find designer-specific work
const allProjects = await getCollection('projects', ({ data }) => !data.draft);

// Create a map of designer slug to their projects
const designerProjects = new Map<string, typeof allProjects>();
for (const designer of sortedDesigners) {
  const projects = allProjects.filter(p => p.data.designer === designer.id);
  designerProjects.set(designer.id, projects);
}
---

<section class="designers" data-bg="var(--color-ink)" data-bg-dark>
  <div class="designers-inner">
    <header class="designers-header">
      <span class="section-label" data-animate>The Team</span>
      <p class="section-description" data-animate style="--stagger: 1">
        Independent thinkers and collaborative makers. The people behind the pixels and the craft behind the concepts.
      </p>
      <a href="/team" class="section-cta" data-animate style="--stagger: 2">
        Meet the team
        <svg class="cta-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </a>
    </header>

    <div class="designers-grid">
      {sortedDesigners.map((designer, index) => {
        const projects = designerProjects.get(designer.id) || [];
        return (
          <article class="designer-card" data-animate style={`--stagger: ${index + 2}`}>
            <div class="designer-avatar">
              <span class="avatar-initial">{designer.data.name.charAt(0)}</span>
            </div>

            <div class="designer-info">
              <h3 class="designer-name">{designer.data.name}</h3>
              <p class="designer-role">{designer.data.role}</p>
              <p class="designer-bio">{designer.data.bio}</p>

              {designer.data.social?.instagram && (
                <a
                  href={`https://instagram.com/${designer.data.social.instagram}`}
                  class="designer-social"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  @{designer.data.social.instagram}
                  <span class="social-arrow" aria-hidden="true">â†—</span>
                </a>
              )}
            </div>

            {projects.length > 0 && (
              <div class="designer-projects">
                <span class="projects-label">Personal Work</span>
                <div class="projects-grid">
                  {projects.slice(0, 2).map((project) => (
                    <a href={`/projects/${project.id}`} class="project-thumb">
                      <Image
                        src={project.data.thumbnail}
                        alt={project.data.title}
                        width={200}
                        height={150}
                        inferSize={true}
                        class="thumb-image"
                      />
                      <span class="thumb-title">{project.data.title}</span>
                    </a>
                  ))}
                </div>
              </div>
            )}
          </article>
        );
      })}
    </div>
  </div>
</section>

<style>
  .designers {
    padding: var(--section-gap) var(--gutter);
  }

  .designers-inner {
    max-width: var(--container-xl);
    margin: 0 auto;
  }

  .designers-header {
    margin-bottom: var(--space-16);
  }

  .section-label {
    display: block;
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-caps);
    text-transform: uppercase;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .section-description {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: var(--font-regular);
    line-height: var(--leading-snug);
    letter-spacing: var(--tracking-tight);
    color: var(--color-text-primary);
    max-width: 680px;
    margin: 0 0 var(--space-6);
  }

  .section-cta {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-wide);
    text-transform: uppercase;
    color: var(--color-text-primary);
    text-decoration: none;
    transition: gap var(--duration-fast) var(--ease-spring);
  }

  .section-cta:hover {
    opacity: 1;
    gap: var(--space-3);
    color: var(--color-accent);
  }

  .cta-arrow {
    transition: transform var(--duration-fast) var(--ease-spring);
  }

  .section-cta:hover .cta-arrow {
    transform: translateX(4px);
  }

  .designers-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-12);
  }

  .designer-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    padding: var(--space-8);
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-xl);
  }

  .designer-avatar {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-accent);
    border-radius: 50%;
  }

  .avatar-initial {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: var(--font-medium);
    color: var(--color-paper);
  }

  .designer-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .designer-name {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: var(--font-regular);
    letter-spacing: var(--tracking-tight);
    color: var(--color-text-primary);
  }

  .designer-role {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-wide);
    text-transform: uppercase;
    color: var(--color-text-muted);
  }

  .designer-bio {
    font-size: var(--text-base);
    line-height: var(--leading-relaxed);
    color: var(--color-text-secondary);
    margin-top: var(--space-2);
  }

  .designer-social {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-accent);
    margin-top: var(--space-2);
    transition: gap var(--duration-fast) var(--ease-spring);
  }

  .designer-social:hover {
    opacity: 1;
    gap: var(--space-2);
  }

  .social-arrow {
    font-size: var(--text-xs);
    transition: transform var(--duration-fast) var(--ease-spring);
  }

  .designer-social:hover .social-arrow {
    transform: translate(2px, -2px);
  }

  .designer-projects {
    margin-top: var(--space-4);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border);
  }

  .projects-label {
    display: block;
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-caps);
    text-transform: uppercase;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .projects-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .project-thumb {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    transition: transform var(--duration-fast) var(--ease-spring);
  }

  .project-thumb:hover {
    opacity: 1;
    transform: translateY(-4px);
  }

  .thumb-image {
    width: 100%;
    height: auto;
    aspect-ratio: 4 / 3;
    object-fit: cover;
    border-radius: var(--radius-lg);
  }

  .thumb-title {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-text-primary);
  }

  @media (max-width: 768px) {
    .designers-grid {
      grid-template-columns: 1fr;
    }

    .section-title {
      font-size: var(--text-4xl);
    }
  }

  @media (max-width: 480px) {
    .designer-card {
      padding: var(--space-6);
    }

    .projects-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
