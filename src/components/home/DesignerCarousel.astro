---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

// Get all designers except studio, ordered by order field
const designers = await getCollection('designers', ({ id, data }) =>
  id !== 'studio' && data.order > 0
);
const sortedDesigners = designers.sort((a, b) => a.data.order - b.data.order);

// Get all self-initiated projects (personal work)
const allProjects = await getCollection('projects', ({ data }) =>
  !data.draft && data.client === 'Self-initiated'
);

// Create designer groups: each designer with their personal projects
interface DesignerGroup {
  designer: typeof sortedDesigners[0];
  projects: typeof allProjects;
  groupNumber: string;
}

const designerGroups: DesignerGroup[] = sortedDesigners.map((designer, index) => ({
  designer,
  projects: allProjects.filter(p => p.data.designer === designer.id).slice(0, 2),
  groupNumber: String(index + 1).padStart(2, '0'),
})).filter(group => group.projects.length > 0);
---

<section class="designer-carousel" data-bg="var(--color-ink)" data-bg-dark>
  <div class="carousel-header-wrap">
    <div class="carousel-header-inner">
      <header class="carousel-header">
        <span class="section-label" data-animate>The Team</span>
        <p class="section-description" data-animate style="--stagger: 1">
          Independent thinkers and collaborative makers. The people behind the pixels and the craft behind the concepts.
        </p>
        <a href="/team" class="section-cta" data-animate style="--stagger: 2">
          Meet the team
          <svg class="cta-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </a>
      </header>
    </div>
  </div>

  <div class="carousel-container">
    <div class="carousel-track" data-designer-carousel>
      {designerGroups.map((group, groupIndex) => {
        const { designer, projects, groupNumber } = group;
        const isFirstGroup = groupIndex === 0;

        return (
          <>
            {/* Visual separator before each group (except first) */}
            {!isFirstGroup && (
              <div class="group-separator" aria-hidden="true">
                <span class="separator-line"></span>
              </div>
            )}

            {/* Designer Profile Card */}
            <article
              class="carousel-item carousel-item--designer"
              data-group={groupNumber}
            >
              <div class="group-number" aria-hidden="true">{groupNumber}</div>

              <div class="designer-profile">
                {designer.data.photo ? (
                  <Image
                    src={designer.data.photo}
                    alt={designer.data.name}
                    width={400}
                    height={500}
                    inferSize={true}
                    class="designer-photo"
                  />
                ) : (
                  <div class="designer-avatar">
                    <span class="avatar-initial">{designer.data.name.charAt(0)}</span>
                  </div>
                )}
                <div class="designer-content">
                  <h3 class="designer-name">{designer.data.name}</h3>
                  <p class="designer-role">{designer.data.role}</p>
                </div>
              </div>
            </article>

            {/* Personal Projects */}
            {projects.map((project) => (
              <article
                class="carousel-item carousel-item--project"
                data-group={groupNumber}
              >
                <a href={`/projects/${project.id}`} class="project-link">
                  <div class="project-image-wrapper">
                    <Image
                      src={project.data.thumbnail}
                      alt={project.data.title}
                      widths={[400, 600, 800]}
                      sizes="(max-width: 768px) 80vw, 400px"
                      inferSize={true}
                      class="project-image"
                    />
                    <div class="project-content">
                      <span class="project-label">Personal Work</span>
                      <h4 class="project-title">{project.data.title}</h4>
                    </div>
                    <div class="project-overlay">
                      <span class="project-view">View</span>
                    </div>
                  </div>
                </a>
              </article>
            ))}
          </>
        );
      })}
    </div>
  </div>

  <!-- Navigation -->
  <div class="carousel-nav">
    <button class="carousel-btn carousel-btn-prev" data-designer-carousel-prev aria-label="Previous">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <button class="carousel-btn carousel-btn-next" data-designer-carousel-next aria-label="Next">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </button>
  </div>
</section>

<style>
  .designer-carousel {
    padding: var(--section-gap) 0;
    overflow: hidden;
  }

  /* Header wrap: applies gutter padding like other sections */
  .carousel-header-wrap {
    padding: 0 var(--gutter);
  }

  /* Header inner: max-width container, centered */
  .carousel-header-inner {
    max-width: var(--container-xl);
    margin: 0 auto;
  }

  .carousel-header {
    margin-bottom: var(--space-16);
  }

  .section-label {
    display: block;
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-caps);
    text-transform: uppercase;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .section-description {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: var(--font-regular);
    line-height: var(--leading-snug);
    letter-spacing: var(--tracking-tight);
    color: var(--color-text-primary);
    max-width: 680px;
    margin: 0 0 var(--space-6);
  }

  .section-cta {
    display: inline-flex;
    align-items: center;
    gap: var(--space-3);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-wide);
    text-transform: uppercase;
    color: var(--color-ink);
    background-color: var(--color-paper);
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-full);
    text-decoration: none;
    transition:
      gap 0.4s cubic-bezier(0.25, 0.1, 0.25, 1),
      background-color 0.35s ease-out,
      color 0.35s ease-out;
  }

  .section-cta:hover {
    opacity: 1;
    gap: var(--space-4);
    background-color: var(--color-accent);
    color: var(--color-paper);
  }

  .cta-arrow {
    transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
  }

  .section-cta:hover .cta-arrow {
    transform: translateX(4px);
  }


  /* Carousel track - horizontal scroll */
  .carousel-container {
    width: 100%;
    overflow: hidden;
  }

  .carousel-track {
    display: flex;
    gap: var(--space-6);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-padding-left: var(--gutter);
    padding: var(--space-4) var(--gutter);
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .carousel-track::-webkit-scrollbar {
    display: none;
  }

  /* ==========================================================================
     Visual Cue #3: Group Separators
     ========================================================================== */
  .group-separator {
    flex: 0 0 auto;
    width: 1px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-8) var(--space-6);
  }

  .separator-line {
    width: 1px;
    height: 60%;
    background: linear-gradient(
      to bottom,
      transparent,
      var(--color-border-strong) 20%,
      var(--color-border-strong) 80%,
      transparent
    );
  }

  /* ==========================================================================
     Carousel Items - Base
     ========================================================================== */
  .carousel-item {
    flex: 0 0 auto;
    scroll-snap-align: start;
    position: relative;
  }

  /* ==========================================================================
     Visual Cue #2: Group Numbers
     ========================================================================== */
  .group-number {
    position: absolute;
    top: 0;
    left: 0;
    font-family: var(--font-display);
    font-size: var(--text-6xl);
    font-weight: var(--font-light);
    line-height: 1;
    color: var(--color-border-strong);
    opacity: 0.4;
    z-index: 0;
    pointer-events: none;
  }

  /* ==========================================================================
     Designer Profile Card
     ========================================================================== */
  .carousel-item--designer {
    width: clamp(320px, 50vw, 420px);
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding-top: var(--space-12);
  }

  .designer-profile {
    position: relative;
    z-index: 1;
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  .designer-photo {
    width: 100%;
    height: auto;
    aspect-ratio: 4 / 5;
    object-fit: cover;
  }

  .designer-avatar {
    width: 100%;
    aspect-ratio: 4 / 5;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-accent);
  }

  .avatar-initial {
    font-family: var(--font-display);
    font-size: var(--text-6xl);
    font-weight: var(--font-medium);
    color: var(--color-paper);
  }

  /* Designer name/role floating over photo */
  .designer-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: var(--space-6);
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.8) 0%,
      rgba(0, 0, 0, 0.5) 50%,
      transparent 100%
    );
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  /* ==========================================================================
     Visual Cue #1: Typography Hierarchy - Designer Names
     Large, medium weight serif for designer names
     ========================================================================== */
  .designer-name {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-tight);
    color: white;
    margin: 0;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .designer-role {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-wide);
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.8);
    margin: 0;
  }

  /* ==========================================================================
     Project Cards
     ========================================================================== */
  .carousel-item--project {
    width: clamp(280px, 40vw, 360px);
    padding-top: var(--space-12);
  }

  .project-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .project-link:hover {
    opacity: 1;
  }

  .project-image-wrapper {
    position: relative;
    aspect-ratio: 4 / 5;
    overflow: hidden;
    background-color: var(--color-bg-tertiary);
    border-radius: var(--radius-xl);
    transition: transform var(--duration-slow) var(--ease-spring);
  }

  .project-link:hover .project-image-wrapper {
    transform: translateY(-8px);
  }

  .project-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-slow) var(--ease-spring);
  }

  .project-link:hover .project-image {
    transform: scale(var(--scale-hover));
  }

  /* Floating text content on project cards */
  .project-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: var(--space-5);
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.75) 0%,
      rgba(0, 0, 0, 0.4) 60%,
      transparent 100%
    );
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    z-index: 1;
  }

  .project-label {
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-caps);
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.7);
  }

  /* ==========================================================================
     Visual Cue #1: Typography Hierarchy - Project Titles
     Thin/light sans-serif for project titles
     ========================================================================== */
  .project-title {
    font-family: var(--font-body);
    font-size: var(--text-xl);
    font-weight: var(--font-light);
    letter-spacing: var(--tracking-normal);
    color: white;
    margin: 0;
    text-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  }

  .project-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-overlay-dark);
    backdrop-filter: var(--backdrop-blur-sm);
    -webkit-backdrop-filter: var(--backdrop-blur-sm);
    opacity: 0;
    transition: opacity var(--duration-normal) var(--ease-out);
    border-radius: var(--radius-xl);
    z-index: 2;
  }

  .project-link:hover .project-overlay {
    opacity: 1;
  }

  .project-view {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-wide);
    text-transform: uppercase;
    color: white;
    padding: var(--space-3) var(--space-6);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: var(--radius-full);
  }

  /* ==========================================================================
     Navigation Buttons
     ========================================================================== */
  .carousel-nav {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
    padding: var(--space-8) var(--gutter) 0;
    max-width: var(--container-xl);
    margin: 0 auto;
  }

  .carousel-btn {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-border-strong);
    border-radius: var(--radius-full);
    color: var(--color-text-primary);
    background: transparent;
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-spring);
  }

  .carousel-btn:hover {
    background-color: var(--color-ink);
    border-color: var(--color-ink);
    color: var(--color-paper);
  }

  .carousel-btn:active {
    transform: scale(var(--scale-press));
  }

  .carousel-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .carousel-btn:disabled:hover {
    background: transparent;
    border-color: var(--color-border-strong);
    color: var(--color-text-primary);
  }

  /* ==========================================================================
     Responsive
     ========================================================================== */
  @media (max-width: 768px) {
    .carousel-item--designer {
      width: 85vw;
    }

    .carousel-item--project {
      width: 75vw;
    }

    .designer-name {
      font-size: var(--text-2xl);
    }

    .group-number {
      font-size: var(--text-5xl);
    }

    .carousel-nav {
      justify-content: center;
    }

    .section-title {
      font-size: var(--text-4xl);
    }
  }

  @media (max-width: 480px) {
    .carousel-item--designer,
    .carousel-item--project {
      width: 90vw;
    }
  }
</style>

<script>
  const track = document.querySelector('[data-designer-carousel]') as HTMLElement;
  const prevBtn = document.querySelector('[data-designer-carousel-prev]') as HTMLButtonElement;
  const nextBtn = document.querySelector('[data-designer-carousel-next]') as HTMLButtonElement;

  if (track && prevBtn && nextBtn) {
    const items = track.querySelectorAll('.carousel-item');

    // Calculate scroll amount based on first item width + gap
    const getScrollAmount = () => {
      const firstItem = items[0] as HTMLElement;
      if (!firstItem) return 0;
      const gap = parseFloat(getComputedStyle(track).gap) || 24;
      return firstItem.offsetWidth + gap;
    };

    const updateButtons = () => {
      const { scrollLeft, scrollWidth, clientWidth } = track;
      prevBtn.disabled = scrollLeft <= 10;
      nextBtn.disabled = scrollLeft >= scrollWidth - clientWidth - 10;
    };

    prevBtn.addEventListener('click', () => {
      track.scrollBy({ left: -getScrollAmount(), behavior: 'smooth' });
    });

    nextBtn.addEventListener('click', () => {
      track.scrollBy({ left: getScrollAmount(), behavior: 'smooth' });
    });

    track.addEventListener('scroll', updateButtons, { passive: true });
    window.addEventListener('resize', updateButtons, { passive: true });

    updateButtons();
  }
</script>
