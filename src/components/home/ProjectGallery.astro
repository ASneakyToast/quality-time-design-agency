---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';

interface Props {
  projects: CollectionEntry<'projects'>[];
  maxItems?: number;
}

const { projects, maxItems = 4 } = Astro.props;

// Limit to specified max
const displayProjects = projects.slice(0, maxItems);

const serviceLabels: Record<string, string> = {
  'branding': 'Branding',
  'web-design': 'Web Design',
  'ui-ux': 'UI/UX',
  'print': 'Print',
  'packaging': 'Packaging',
  'illustration': 'Illustration',
  'motion': 'Motion',
  'photography': 'Photography',
};

// Create project groups: each project with placeholder additional images
// (Using the same thumbnail as placeholders until more images are added)
interface ProjectGroup {
  project: CollectionEntry<'projects'>;
  groupNumber: string;
}

const projectGroups: ProjectGroup[] = displayProjects.map((project, index) => ({
  project,
  groupNumber: String(index + 1).padStart(2, '0'),
}));
---

<section class="project-gallery" data-bg="var(--color-ink)" data-bg-dark>
  <div class="gallery-header-wrap">
    <div class="gallery-header-inner">
      <header class="gallery-header">
        <span class="section-label" data-animate>Selected Work</span>
        <p class="section-description" data-animate style="--stagger: 1">
          A curated selection of projects where strategy meets craft. Each one a testament to what thoughtful design can achieve.
        </p>
        <a href="/work" class="section-cta" data-animate style="--stagger: 2">
          View all projects
          <svg class="cta-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </a>
      </header>
    </div>
  </div>

  <div class="gallery-container">
    <div class="gallery-track" data-project-gallery>
      {projectGroups.map((group) => {
        const { project, groupNumber } = group;
        const { title, client, heroImage, thumbnail, services, year } = project.data;

        return (
          <>
            {/* Main Project Card */}
            <article
              class="gallery-item gallery-item--main"
              data-group={groupNumber}
            >
              <div class="group-number" aria-hidden="true">{groupNumber}</div>

              <a href={`/projects/${project.id}`} class="project-link">
                <div class="project-main-wrapper">
                  <Image
                    src={heroImage || thumbnail}
                    alt={`${title} - ${client}`}
                    widths={[400, 600, 800]}
                    sizes="(max-width: 768px) 80vw, 420px"
                    class="project-main-image"
                  />
                  <div class="project-content">
                    <div class="project-meta">
                      <span class="project-client">{client}</span>
                      <span class="project-divider">/</span>
                      <span class="project-year">{year}</span>
                    </div>
                    <h3 class="project-title">{title}</h3>
                    <p class="project-services">
                      {services.map((s) => serviceLabels[s] || s).join(' / ')}
                    </p>
                  </div>
                  <div class="project-overlay">
                    <span class="project-view">View Project</span>
                  </div>
                </div>
              </a>
            </article>

            {/* Secondary Images (placeholders using same thumbnail) */}
            <article
              class="gallery-item gallery-item--secondary"
              data-group={groupNumber}
            >
              <a href={`/projects/${project.id}`} class="project-link">
                <div class="project-secondary-wrapper">
                  <Image
                    src={thumbnail}
                    alt={`${title} detail`}
                    widths={[300, 450, 600]}
                    sizes="(max-width: 768px) 60vw, 280px"
                    class="project-secondary-image"
                  />
                  <div class="project-overlay">
                    <span class="project-view">View</span>
                  </div>
                </div>
              </a>
            </article>

            <article
              class="gallery-item gallery-item--secondary"
              data-group={groupNumber}
            >
              <a href={`/projects/${project.id}`} class="project-link">
                <div class="project-secondary-wrapper">
                  <Image
                    src={thumbnail}
                    alt={`${title} detail`}
                    widths={[300, 450, 600]}
                    sizes="(max-width: 768px) 60vw, 280px"
                    class="project-secondary-image"
                  />
                  <div class="project-overlay">
                    <span class="project-view">View</span>
                  </div>
                </div>
              </a>
            </article>
          </>
        );
      })}
    </div>
  </div>

  <!-- Navigation -->
  <div class="gallery-nav">
    <button class="gallery-btn gallery-btn-prev" data-project-gallery-prev aria-label="Previous">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <button class="gallery-btn gallery-btn-next" data-project-gallery-next aria-label="Next">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </button>
  </div>
</section>

<style>
  .project-gallery {
    padding: var(--section-gap) 0;
    overflow: hidden;
  }

  /* Header wrap: applies gutter padding like other sections */
  .gallery-header-wrap {
    padding: 0 var(--gutter);
  }

  /* Header inner: max-width container, centered */
  .gallery-header-inner {
    max-width: var(--container-xl);
    margin: 0 auto;
  }

  .gallery-header {
    margin-bottom: var(--space-16);
  }

  .section-label {
    display: block;
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-caps);
    text-transform: uppercase;
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .section-description {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: var(--font-regular);
    line-height: var(--leading-snug);
    letter-spacing: var(--tracking-tight);
    color: var(--color-text-primary);
    max-width: 680px;
    margin: 0 0 var(--space-6);
  }

  .section-cta {
    display: inline-flex;
    align-items: center;
    gap: var(--space-3);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-wide);
    text-transform: uppercase;
    color: var(--color-ink);
    background-color: var(--color-paper);
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-full);
    text-decoration: none;
    cursor: pointer;
    transition:
      gap 0.4s cubic-bezier(0.25, 0.1, 0.25, 1),
      background-color 0.35s ease-out,
      color 0.35s ease-out;
  }

  .section-cta:hover {
    opacity: 1;
    gap: var(--space-4);
    background-color: var(--color-accent);
    color: var(--color-paper);
  }

  .cta-arrow {
    transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
  }

  .section-cta:hover .cta-arrow {
    transform: translateX(4px);
  }


  /* Gallery track - horizontal scroll */
  .gallery-container {
    width: 100%;
    overflow: hidden;
  }

  .gallery-track {
    display: flex;
    gap: var(--space-6);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-padding-left: var(--gutter);
    padding: var(--space-4) var(--gutter);
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .gallery-track::-webkit-scrollbar {
    display: none;
  }

  /* ==========================================================================
     Gallery Items - Base
     ========================================================================== */
  .gallery-item {
    flex: 0 0 auto;
    scroll-snap-align: start;
    position: relative;
  }

  /* ==========================================================================
     Group Numbers
     ========================================================================== */
  .group-number {
    position: absolute;
    top: 0;
    left: 0;
    font-family: var(--font-display);
    font-size: var(--text-6xl);
    font-weight: var(--font-light);
    line-height: 1;
    color: var(--color-border-strong);
    opacity: 0.4;
    z-index: 0;
    pointer-events: none;
  }

  /* ==========================================================================
     Main Project Card
     ========================================================================== */
  .gallery-item--main {
    width: clamp(340px, 50vw, 440px);
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding-top: var(--space-12);
  }

  .project-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .project-link:hover {
    opacity: 1;
  }

  .project-main-wrapper {
    position: relative;
    z-index: 1;
    border-radius: var(--radius-xl);
    overflow: hidden;
    aspect-ratio: 4 / 5;
    transition: transform var(--duration-slow) var(--ease-spring);
  }

  .project-link:hover .project-main-wrapper {
    transform: translateY(-8px);
  }

  .project-main-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-slow) var(--ease-spring);
  }

  .project-link:hover .project-main-image {
    transform: scale(var(--scale-hover));
  }

  /* Project info floating over image */
  .project-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: var(--space-6);
    background: linear-gradient(
      to top,
      rgba(0, 0, 0, 0.85) 0%,
      rgba(0, 0, 0, 0.5) 60%,
      transparent 100%
    );
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    z-index: 1;
  }

  .project-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-caps);
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.7);
  }

  .project-divider {
    opacity: 0.5;
  }

  .project-title {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-tight);
    color: white;
    margin: 0;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .project-services {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--font-light);
    color: rgba(255, 255, 255, 0.8);
    margin: 0;
  }

  .project-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-overlay-dark);
    backdrop-filter: var(--backdrop-blur-sm);
    -webkit-backdrop-filter: var(--backdrop-blur-sm);
    opacity: 0;
    transition: opacity var(--duration-normal) var(--ease-out);
    border-radius: var(--radius-xl);
    z-index: 2;
  }

  .project-link:hover .project-overlay {
    opacity: 1;
  }

  .project-view {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    letter-spacing: var(--tracking-wide);
    text-transform: uppercase;
    color: white;
    padding: var(--space-3) var(--space-6);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: var(--radius-full);
  }

  /* ==========================================================================
     Secondary Project Images (smaller)
     ========================================================================== */
  .gallery-item--secondary {
    width: clamp(240px, 35vw, 300px);
    padding-top: var(--space-12);
  }

  .project-secondary-wrapper {
    position: relative;
    aspect-ratio: 3 / 4;
    overflow: hidden;
    background-color: var(--color-bg-tertiary);
    border-radius: var(--radius-xl);
    transition: transform var(--duration-slow) var(--ease-spring);
  }

  .project-link:hover .project-secondary-wrapper {
    transform: translateY(-6px);
  }

  .project-secondary-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-slow) var(--ease-spring);
  }

  .project-link:hover .project-secondary-image {
    transform: scale(var(--scale-hover));
  }

  /* ==========================================================================
     Navigation Buttons
     ========================================================================== */
  .gallery-nav {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
    padding: var(--space-8) var(--gutter) 0;
    max-width: var(--container-xl);
    margin: 0 auto;
  }

  .gallery-btn {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--color-border-strong);
    border-radius: var(--radius-full);
    color: var(--color-text-primary);
    background: transparent;
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-spring);
  }

  .gallery-btn:hover {
    background-color: var(--color-ink);
    border-color: var(--color-ink);
    color: var(--color-paper);
  }

  .gallery-btn:active {
    transform: scale(var(--scale-press));
  }

  .gallery-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .gallery-btn:disabled:hover {
    background: transparent;
    border-color: var(--color-border-strong);
    color: var(--color-text-primary);
  }

  /* ==========================================================================
     Responsive
     ========================================================================== */
  @media (max-width: 768px) {
    .gallery-item--main {
      width: 85vw;
    }

    .gallery-item--secondary {
      width: 65vw;
    }

    .project-title {
      font-size: var(--text-2xl);
    }

    .group-number {
      font-size: var(--text-5xl);
    }

    .gallery-nav {
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    .gallery-item--main {
      width: 90vw;
    }

    .gallery-item--secondary {
      width: 75vw;
    }
  }
</style>

<script>
  function initProjectGallery() {
    const track = document.querySelector('[data-project-gallery]') as HTMLElement;
    const prevBtn = document.querySelector('[data-project-gallery-prev]') as HTMLButtonElement;
    const nextBtn = document.querySelector('[data-project-gallery-next]') as HTMLButtonElement;

    if (track && prevBtn && nextBtn) {
      const items = track.querySelectorAll('.gallery-item');

      // Calculate scroll amount based on first item width + gap
      const getScrollAmount = () => {
        const firstItem = items[0] as HTMLElement;
        if (!firstItem) return 0;
        const gap = parseFloat(getComputedStyle(track).gap) || 24;
        return firstItem.offsetWidth + gap;
      };

      const updateButtons = () => {
        const { scrollLeft, scrollWidth, clientWidth } = track;
        prevBtn.disabled = scrollLeft <= 10;
        nextBtn.disabled = scrollLeft >= scrollWidth - clientWidth - 10;
      };

      prevBtn.addEventListener('click', () => {
        track.scrollBy({ left: -getScrollAmount(), behavior: 'smooth' });
      });

      nextBtn.addEventListener('click', () => {
        track.scrollBy({ left: getScrollAmount(), behavior: 'smooth' });
      });

      track.addEventListener('scroll', updateButtons, { passive: true });
      window.addEventListener('resize', updateButtons, { passive: true });

      updateButtons();
    }
  }

  // Initialize on load
  initProjectGallery();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initProjectGallery);
</script>
